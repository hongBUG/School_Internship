<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="cn.tentact.nebula.db.dao.I_UserDao">
	<!-- 获取登陆信息 -->
	<select id="searchUsernamePassword" parameterType="Map" resultType="Map">
		SELECT
			username,
			CAST(AES_DECRYPT(UNHEX(password), "nebula") AS CHAR) AS password
		FROM
			user
		WHERE
			username = #{username}
		AND
			identity IN ("管理者","学员")
		AND
			account = "正常"
	</select>
	<!-- 查询用户信息 -->
	<select id="searchInfo" parameterType="String" resultType="Map">
		SELECT
			u.username,
			u.photo_path,
			u.tel,
			u.email,
			j.exp,
			j.type,
			j.authentication 
		FROM
			jobseeker AS j
		JOIN 
			`user` AS u 
		ON 
			j.user_id = u.id 
		WHERE
			u.username = #{username}
	</select>
	<insert id="add" parameterType="Map">
		INSERT IGNORE INTO user(
			username,
			password,
			identity,
			company_id,
			name,
			sex,
			tel,
			email,
			wechat,
			role
		)
		VALUES(
			#{username},
			HEX(AES_ENCRYPT(#{password}, "nebula")),
			#{identity},
			#{company_id},
			#{name},
			#{sex},
			#{tel},
			#{email},
			#{wechat},
			JSON_ARRAY(#{role})
		);
	</insert>
	
	<!-- 找回密码 -->
	<select id="searchPassword" parameterType="Map" resultType="String">
		SELECT
  			AES_DECRYPT(UNHEX(password), "nebula") AS password
		FROM
			user
		WHERE
			username = #{username}
		AND 
			email = #{email}
		AND 
			identity = "求职者";
	</select>
	
	<!-- 更新登陆时间 -->
	<update id="updateLoginTime" parameterType="String">
		UPDATE 
			`user`
		SET 
			login_time = now()
		WHERE
			username = #{username};	
	</update>
</mapper>